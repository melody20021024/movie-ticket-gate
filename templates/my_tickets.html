<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} çš„ç¥¨åˆ¸è¨˜éŒ„</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background: #f7f7f7;
            padding: 30px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .back-btn:hover {
            background: #0056b3;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 700px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .preview-btn {
            padding: 6px 12px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 4px;
            display: inline-block;
        }
        .preview-btn:hover {
            background: #218838;
        }
        .no-tickets {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 18px;
        }
        .ticket-count {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
        }
        @media (max-width: 700px) {
            .container { padding: 10px; }
            h1 { font-size: 1.2em; }
            .back-btn { width: 100%; margin-bottom: 10px; }
            .table-wrapper { margin: 0 -10px; }
            table { font-size: 13px; min-width: 500px; }
            th, td { padding: 8px; }
        }
        @media (max-width: 500px) {
            .container { padding: 2px; }
            table { font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">â† è¿”å›é¦–é </a>
        <h1>ğŸ« {% if name %}{{ name }}{% elif email %}{{ email }}{% else %}æŸ¥è©¢ç¥¨åˆ¸{% endif %} çš„ç¥¨åˆ¸è¨˜éŒ„</h1>
        {% if tickets is none %}
        <form method="get" action="/my_tickets/" style="max-width:400px;margin:30px auto 0 auto;text-align:center;">
            <label style="font-weight:bold;">è«‹è¼¸å…¥å§“åæˆ– Email æŸ¥è©¢ç¥¨åˆ¸ï¼š</label><br>
            <input type="text" name="name" placeholder="å§“å" style="padding:8px;margin:8px 0;width:80%;border-radius:4px;border:1px solid #ccc;">
            <div style="margin:8px 0;">æˆ–</div>
            <input type="email" name="email" placeholder="Email" style="padding:8px;margin-bottom:8px;width:80%;border-radius:4px;border:1px solid #ccc;">
            <br>
            <button type="submit" class="preview-btn" style="background:#1976d2;">æŸ¥è©¢ç¥¨åˆ¸</button>
        </form>
        {% else %}
        <div class="ticket-count">
            å…±æ‰¾åˆ° {{ tickets|length }} å¼µç¥¨åˆ¸
        </div>
        {% if tickets %}
        <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ç¥¨åˆ¸ ID</th>
                    <th>é›»å½±</th>
                    <th>åº§ä½</th>
                    <th>å»ºç«‹æ™‚é–“</th>
                    <th>é©—è­‰ç‹€æ…‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                {% set my_ticket_count = (tickets|selectattr('owner_email', 'equalto', email)|list|length if email else 0) + (tickets|selectattr('name', 'equalto', name)|list|length if name else 0) %}
                <tr>
                    <td><strong>{{ ticket.id }}</strong></td>
                    <td>{{ ticket.movie }}</td>
                    <td>{{ ticket.seat }}</td>
                    <td>{{ ticket.created_at }}</td>
                    <td>
                        {% if ticket.verified %}
                        <span style="color: #28a745; font-weight: bold;">âœ… å·²é©—è­‰</span>
                        {% else %}
                        <span style="color: #dc3545;">âŒ æœªé©—è­‰</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/preview_ticket/{{ ticket.id }}" class="preview-btn">ğŸ“· é è¦½ç¥¨åˆ¸</a>
                        {% if not ticket.verified %}
                        <a href="/verify_ticket/{{ ticket.id }}" class="preview-btn" style="background: #dc3545; margin-left: 5px;">ğŸ” é©—ç¥¨</a>
                        {% else %}
                        <span class="preview-btn" style="background: #6c757d; margin-left: 5px; cursor: not-allowed;">âœ… å·²é©—è­‰</span>
                        {% endif %}
                        {% if (email and ticket.owner_email == email) or (name and ticket.name == name) %}
                          {% if my_ticket_count > 1 %}
                            <button class="preview-btn" style="background:#ffc107;color:#333;margin-left:5px;" onclick="toggleTransferForm('{{ ticket.id }}')">âœ‰ï¸ åˆ†ç¥¨</button>
                            <form method="post" action="/transfer_ticket/{{ ticket.id }}" class="transfer-form" id="transfer-{{ ticket.id }}" style="display:none;margin-top:8px;" onsubmit="return transferTicketAjax(event, '{{ ticket.id }}')">
                              <input type="text" name="new_name" placeholder="å—è®“äººå§“å" required style="padding:4px 8px;border-radius:4px;border:1px solid #ccc;margin-bottom:4px;">
                              <input type="email" name="new_email" placeholder="å—è®“äººEmail" required style="padding:4px 8px;border-radius:4px;border:1px solid #ccc;">
                              <button type="submit" class="preview-btn" style="background:#1976d2;color:#fff;">ç¢ºèªåˆ†ç¥¨</button>
                              <span class="transfer-success" id="success-{{ ticket.id }}" style="display:none;color:#28a745;font-weight:bold;margin-left:8px;">åˆ†ç¥¨æˆåŠŸï¼</span>
                            </form>
                          {% else %}
                            <button class="preview-btn" style="background:#ccc;color:#888;margin-left:5px;cursor:not-allowed;" onclick="alert('åƒ…å‰©ä¸€å¼µç¥¨ä¸å¯åˆ†ç¥¨ï¼')" disabled>âœ‰ï¸ åˆ†ç¥¨</button>
                          {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="no-tickets">
            <p>ğŸ“­ ç›®å‰æ²’æœ‰æ‰¾åˆ°ä»»ä½•ç¥¨åˆ¸è¨˜éŒ„</p>
            <p>å¿«å» <a href="/" style="color: #007bff;">é¦–é </a> è³¼è²·é›»å½±ç¥¨å§ï¼</p>
        </div>
        {% endif %}
        {% endif %}
    </div>
    <script>
    function toggleTransferForm(ticketId) {
      var form = document.getElementById('transfer-' + ticketId);
      if(form.style.display === 'none') {
        form.style.display = '';
      } else {
        form.style.display = 'none';
      }
    }
    async function transferTicketAjax(e, ticketId) {
      e.preventDefault();
      var form = document.getElementById('transfer-' + ticketId);
      var formData = new FormData(form);
      let resp = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      let text = await resp.text();
      if (text.includes('åˆ†ç¥¨æˆåŠŸ')) {
        document.getElementById('success-' + ticketId).style.display = '';
        setTimeout(()=>{
          form.style.display = 'none';
          document.getElementById('success-' + ticketId).style.display = 'none';
        }, 1500);
      } else {
        alert(text);
      }
      return false;
    }
    </script>
</body>
</html> 